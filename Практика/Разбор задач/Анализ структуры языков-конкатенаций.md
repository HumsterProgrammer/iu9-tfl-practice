Пусть дан язык $\mathcal{L}$ , определённый как множество конкатенаций слов, на которые наложены некоторые ограничения (возможно, связывающие их друг с другом).
Как анализировать такие языки на их принадлежность классу контекстно-свободных (регулярных)?

Выделим главные свойства языков, позволяющие быстрее строить их описания либо контрпримеры, к которым можно применять леммы о накачках.

Пусть слова языка $\mathcal{L}$ представлены как конкатенации слов $\omega_1$,..., $\omega_n$ с дополнительными ограничениями на некоторые из $\omega_i$.

Относительно частей $\omega_1$, $\dots$, $\omega_n$ полезно выяснить следующие их свойства.
1. Запрещённые подслова (англ. *forbidden factors*) - подслова, которые не могут появиться ни в одном слове $\omega_i$, подчиняющемся ограничениям языка.
2. Неизбегаемые шаблоны (англ. *unavoidable patterns*) - шаблоны (подслова или структуры), которые обязательно появляются в каждом слове $\omega_i$, подчиняющемся ограничениям.
3. Инварианты соотношений - предикаты $P_j(\omega_{i_1},...,\omega_{i_k})$, выполняющиеся при любом выборе слов $\omega_i$ в ограничениях языка.
Если анализ свойств составляющих языка проведён успешно, можно воспользоваться его результатами в следующем ключе.

Если известно, что $\sigma$ - неизбегаемый шаблон в $\omega_i$, тогда можно "заякорить" $\omega_i$ посредством ограничения слов, подходящих под шаблон $\sigma$. При выборе слова для накачки имеет смысл также зафиксировать число якорей посредством пересечения с регулярным языком.

Якори могут возникать не только в подсловах, из которых собираются слова языка, но и на стыках между подсловами.

> [!example] Неизбегаемые шаблоны на примере языка $\bigl\{\omega_0\omega_1 \omega^R_1 \omega_1 \omega_2 \mid |\omega_1|>1\bigr\}$ 
> 
> Рассмотрим задачу проанализировать этот язык в алфавите $\{a,b\}$ на контекстную свободу. Неизбегаемые шаблоны на стыках $\omega_1\omega^R_1$ и $\omega^R_1\omega_1$ здесь - вида $ts^{2k}t$, где  $s,t$ - различные буквы, если $\omega_1$ не в унарном алфавите (содержит как буквы $a$, так и буквы $b$),  и $s^6$, если $\omega_1$ в унарном алфавите.
> Чтобы зафиксировать соответствующие переходы, построим слово, в котором нет подслов в унарном алфавите длины больше 5 и ровно два максимальных подслова в унарном алфавите имеют чётную длину, и тем самым являются требуемыми якорями. Например, при предполагаемой длине накачки $p$ построим следующие компоненты:
> $$\begin{cases}\omega_0 = \varepsilon\\ 
> \omega_1 = ab(a^5b)^{2p+1}a\\
> \omega_2 = \varepsilon
> \end{cases}
> $$
> Рассмотрим возможные альтернативные разбиения их конкатенации 
>$$\omega = ab(a^5b)^{2p}a^5\underbrace{b a a b}_{\text{переход }\omega_1\omega^R_1}(a^5b)^{2p} a^5 \underbrace{ba a b}_{\text{переход }\omega^R_1\omega_1}(a^5 b)^{2p} a^5 ba$$ 
> Здесь $\omega^R_1$ оказывается заякорено между двумя вхождениями $baab$, значит, $|\omega^R_1|=12p+9$, а поскольку $|\omega_1|=|\omega^R_1|$, то никаких других разбиений $\omega$ на подслова $\omega_0$, $\omega_1$, $\omega_2$ не существует.
> После построения контрпримера и фиксации якорей пересечением с регулярным выражением $ab(a^5ba^5b)^*a^5baab(a^5ba^5b)^*a^5baab(a^5ba^5b)^*a^5ba$ опровержение контекстной свободы рассматриваемого языка не представляет никакой сложности.

Если известно, что $\upsilon$ - запрещённое подслово в $\omega_i$, но оно не является запрещённым в $\omega_{i+1}$ и $\omega_{i-1}$, тогда можно ограничить возможности выделения (дрейфа) фрагмента $\omega_i$ , окружив его подсловами $\upsilon$.

Дополнительно полезно использовать инварианты (в частности, инварианты соотношений длин или соотношений на вхождения подслов), для того чтобы зафиксировать относительные размеры слов $\omega_i$. Особенно удобны инварианты длин при переборе возможных накачек: если подслова в слове-контрпримере заякорены, зачастую этот перебор становится ненужным, потому что изменение размеров подслов немедленно нарушает инвариант.

> [!example] Запрещённые подслова на примере языка $\bigl\{\omega\, h_1(\omega) h_2(\omega)\mid h_1(a)=ab\,\&\,h_1(b)=ba\,\&\,h_2(a)=b\,\&\,h_2(b)=ab\bigr\}$
> Алфавит опять $\{a,b\}$, задача - анализ на КС-свойство. Здесь удобно выделить запрещённые подслова в гомоморфных образах $\omega$:
> - во фрагменте $h_1(\omega)$ - это $a^3$, $b^3$, $a^2ba$, $aba^2$, $bab^2$,...
> - во фрагменте $h_2(\omega)$ - это $a^2$.
> Таким образом, любой префикс, заканчивающийся на $a^3$, точно принадлежит $\omega$; любой достаточно короткий суффикс, начинающийся на $b^3$, точно принадлежит $h_2(\omega)$.
> С учётом этой особенности, построим компоненты слова, зависящие от длины накачки $p$:
> $$\begin{cases}\omega = a^p b^p a^3\\ 
h_1(\omega) = (ab)^p(ba)^p(ab)^3 \\
h_2(\omega) = b^p (ab)^p b^3
\end{cases}$$
> Опять рассмотрим альтернативные разбиения:
> $$\omega'=\overbrace{a^p b^p\underbrace{a^3}_{\text{якорь }\omega}}^{\text{точно }\omega}(ab)^p(ba)^p(ab)^3 \overbrace{\underbrace{b^p}_{\text{якорь }h_2(\omega)} (ab)^p b^3}^{\text{точно }h_2(\omega)}$$
> Поскольку выполняется инвариант $|h_1(\omega)|=2\cdot |\omega|$, $|h_2(\omega)|=|\omega|_a+2\cdot|\omega|_b$ и $a^3$ не может входить в $h_1(\omega)$, а $b^3$ - в $h_1(\omega)$ разбиение $\omega'$ на подслова однозначно. 
> С целью сохранить структуру слов, пересечём исходный язык с регулярным $a^* b^* a^3 (ab)^*(ba)^*(ab)^3 b^* (ab)^* b^3$. Теперь любая накачка сохраняет якори, и все накачки немедленно нарушают инвариант $|h_1(\omega)|=2\cdot|\omega|$, $|h_2(\omega)|=|\omega|_a+2\cdot|\omega|_b$ .

Ниже - разбор некоторых языков конкатенаций из *Рубежного Контроля I*. 

[[Вариант 8]]  Анализ языка $\bigl\{w_1 w_2 w_3 | w_1 w_3 = h(w_2)\,\&\,w_2 \in \{a,b\}^*\bigr\}$, где $h$ - это гомоморфизм, определяемый как $h(a) = aa$, $h(b)=ab$.
- Неизбегаемые шаблоны:
$$
\begin{array}{l}
w_1 \text{ лежит в регулярке }(a(a|b))^*\\
w_3 \text{ лежит в регулярке }(a(a|b))^*|((a|b)a)^*(a|b)
\end{array}
$$
- Запрещённые подслова - как следует из предыдущего пункта, в $w_1$ и $w_3$ это $bb$.
- Инварианты - $|w_1|+|w_3|=2\cdot|w_2|$, $|w_1|_b + |w_3|_b = |w_2|_b$.
На основе указанных наблюдений легко выявить базовую структуру слова-контрпримера:
 $$w=\underbrace{a^{4p}(ab)^{2p}}_{(2)\text{ точно в }w_1\text{ (из-за (1))} }\overbrace{a^{2p}}^{(3) \text{ в }w_2\text{ (из-за (2))}}\underbrace{b^{2p}a^{2p}b^{2p}}_{\text{(1) точно в }w_2 \text{ (якори } b^2)}\overbrace{a^{4p}(ab)^{2p}}^{(4)\text{ в }w_3 (\text{инвариант длин и (1)-(3)})}$$